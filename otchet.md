## Part 1. Инструмент ipcalc

### 1.1 Маски и сети
- Поднята виртуальная машина ws1, на которую установлена Ubuntu 20.04 Server LTS

- Адрес сети *192.167.38.54/13*:

![](pics/img1.jpg)
Определяется как: 192.160.0.0/13

- Перевод маски 255.255.255.0 в префиксную и двоичную запись, /15 в обычную и двоичную, 11111111.11111111.11111111.11110000 в обычную и префиксную

*Префикс маски - это короткая запись сетевой маски, определяет количество бит порции сети.*

  - 1.1. Маска *255.255.255.0* в префиксной записи: /24
    - 1.2. Маска *255.255.255.0* в двоичной записи  : 11111111.11111111.11111111.00000000
  - 2.1. */15* в обычной записи : 255.254.0.0
    - 2.2. */15* в двоичной записи: 11111111.11111110.00000000.00000000
  - 3.1.*11111111.11111111.11111111.11110000* в обычной записи  : 255.255.255.240 ( (т.к. 1110000 = 240))
    - 3.2. *11111111.11111111.11111111.11110000* в префиксной записи: /28

![](pics/img2.jpg)

- Минимальный и максимальный хост в сети 12.167.38.4 при масках: /8, 11111111.11111111.00000000.00000000, 255.255.254.0 и /4

> ipcalc 12.167.38.4/8
  - минимальный хост 12.0.0.1
  - максимальный хост 12.255.255.254

> ipcalc 12.167.38.4/255.255.0.0
  - минимальный хост 12.167.0.1
  - максимальный хост 12.167.255.254

> ipcalc 12.167.38.4/255.255.254.0
  - минимальный хост 12.167.38.1
  - максимальный хост 12.167.39.254

> ipcalc 12.167.38.4/4
  - минимальный хост 0.0.0.1
  - максимальный хост 15.255.255.254

![](pics/img3.1.jpg)
![](pics/img3.2.jpg)

### 1.2 localhost
- Обращение к приложению, работающему на localhost, со следующими IP: 194.34.23.100, 127.0.0.2, 127.1.0.1, 128.0.0.1

*Localhost — в компьютерных сетях, стандартное, официально зарезервированное доменное имя для частных IP-адресов (в диапазоне 127.0.0.1 — 127.255.255.254)*

> ipcalc 127.0.0.1

![](pics/img4.jpg)

*194.34.23.100* - нет

*127.0.0.2* - да

*127.1.0.1* - да

*128.0.0.1* - нет

#### 1.3. Диапазоны и сегменты сетей

- Публичные и частные IP-адреса:

![](pics/img5.1.jpg)

*10.0.0.45*      - частный

*134.43.0.2*     - публичный 

*192.168.4.2*    - частный

*172.20.250.4*   - частный

*172.0.2.1*      - публичный 

*192.172.0.1*    - публичный 

*172.68.0.2*     - публичный 

*172.16.255.255* - частный

*10.10.10.10*    - частный

*192.169.168.1*  - публичный

-  Какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: 

![](pics/img5.2.jpg)

*10.0.0.1*    - нет

*10.10.0.2*   - да

*10.10.10.10* - да

*10.10.100.1* - нет

*10.10.1.255* - да

## Part 2. Статическая маршрутизация между двумя машинами

- Подняты две виртуальные машины ws1 и ws2, на которые установлена Ubuntu 20.04 Server LTS

![](pics/img6.1.jpg)

- Просмотр существующих сетевых инерфейсов с помощью команды 
> ip a

на  ws1 

![](pics/img6.2.jpg)

на  ws2

![](pics/img6.3.jpg)

- Изменяем netplan в соответствии с заданием

![](pics/img6.4.jpg)

![](pics/img6.5.jpg)

- Применяем netplan apply к каждой машине

![](pics/img6.6.jpg)

![](pics/img6.7.jpg)


#### 2.1. Добавление статического маршрута вручную

- Добавление статического маршрута от одной машины до другой и обратно при помощи команды вида ip r add:
ws1 

> sudo ip r add 172.24.116.8 dev enp0s3
ws2

![](pics/img6.8.jpg)

> sudo ip r add 192.168.100.10 dev enp0s3

![](pics/img6.9.jpg)

Предварительно в настройках VirtualBox создана локальная сеть NAT, к которой подключены ws1 и ws2 + netplan apply. 

- Пинг соединений между машинами:

![](pics/img6.10.jpg)

#### 2.2. Добавление статического маршрута с сохранением

- Перезапущены машины.

- Добавлен статический маршрут от одной машины до другой с помощью файла */etc/netplan/00-installer-config.yaml*:

ws1 и ws2

> sudo nano /etc/netplan/00-installer-config.yaml 

![](pics/img6.11.jpg)

- Пинг соединений между машинами: 

ws1 и ws2 
> ping 172.24.116.8/ping 192.168.100.10

![](pics/img6.12.jpg)

## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения

- 8 Mbps = 1 MB/s
- 100 MB/s = 800 000 Kbps
- 1 Gbps = 1000 Mbps

#### 3.2. Утилита **iperf3**

> sudo apt install iperf3

iperf3 - это утилита командной строки для измерения пропускной способности сети между двумя устройствами. Она позволяет оценить скорость передачи данных между клиентским и серверным устройствами.

- Запускаем на ws1 в режиме сервера с выводом результата в MB/s: iperf3 --server

- Запускаем на ws2 в режиме клиента: iperf3 --client 192.168.100.10

![](pics/img7.1.jpg)

Скорость соединения между машинами - 1.87 Gbits/sec 


## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**

- Создадим файлы /etc/firewall.sh, имитирующие фаерволл, на ws1 и ws2:
Добавим в файлы подряд следующие правила:
  - доступ для порта 22 (ssh) и порта 80 (http)
  - на ws1 сначала запретим echo-reply(ping), затем разрешим:
  - на ws2 сначала разрешим echo-reply(ping), затем запретим:

![](pics/img8.1.jpg)

Запустим файлы на обеих машинах командами 
> sudo chmod +x /etc/firewall.sh 
> sudo /etc/firewall.sh

![](pics/img8.2.jpg)

- Флаг -j в команде iptables используется для указания целевого действия, которое должно быть выполнено, если пакет соответствует заданным условиям в правиле. Так как на машине ws1 первым срабатывает правило DROP, то пакет отбрасывается и пинг от ws2 до ws1 не будет работать. Разрешающее правило, которое идет следующим уже не срабатывает. На ws2 первым действием срабатывает ACCEPT, пакет принимается и пинг работает.

#### 4.2. Утилита **nmap**
- Командой *ping* находим машину, которая не «пингуется»: 
ws1 - пингуется, ws2 - не пингуется
![](pics/img8.3.jpg)

-  Утилита *nmap* показывает, что хост машины запущен:

![](pics/img8.4.jpg)

*в выводе nmap : Host is up*

- Сохранены дампы образов виртуальных машин через интерфейс VirtualBox

![](pics/img8.5.jpg)

![](pics/img8.6.jpg)

## Part 5. Статическая маршрутизация сети

- Подняты пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2)).

![](pics/img9.0.jpg)

#### 5.1. Настройка адресов машин

- Настроены конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети в задании: 

ws11 
![](pics/img9.1.jpg)

ws 21 
![](pics/img9.2.jpg)

ws 22 
![](pics/img9.3.jpg)

r1
![](pics/img9.4.jpg)

r2
![](pics/img9.5.jpg)

- Перезапущен сервис сети, ошибок нет. Командой `ip -4 a` проверяем, что адрес машины задан верно:

ws11
![](pics/img9.6.jpg)

ws 21
![](pics/img9.7.jpg)

ws 22 
![](pics/img9.8.jpg)

r1
![](pics/img9.9.jpg)

r2
![](pics/img9.10.jpg)

- Пинг ws22 с ws21:
![](pics/img9.11.jpg)

- Пинг r1 с ws11:
![](pics/img9.12.jpg)

#### 5.2. Включение переадресации IP-адресов

- Для включения переадресации IP выполним команду на роутерах *sysctl -w net.ipv4.ip_forward=1* (при таком подходе переадресация не будет работать после перезагрузки системы):

r1 
![](pics/img9.13.jpg)

r2
![](pics/img9.14.jpg)

- В файл */etc/sysctl.conf* добавлена строка *net.ipv4.ip_forward = 1* (при использовании этого подхода IP-переадресация включена на постоянной основе):

r1
![](pics/img9.15.jpg)

r2
![](pics/img9.16.jpg)

#### 5.3. Установка маршрута по-умолчанию

- Настроены маршруты по умолчанию (шлюзы) для рабочих станций в *etc/netplan/00-installer-config.yaml*:

ws11
![](pics/img9.17.jpg)

ws 21
![](pics/img9.18.jpg)

ws 22
![](pics/img9.19.jpg)

- При вызове `ip r` видно, что добавился маршрут в таблицу маршрутизации:

ws11
![](pics/img9.20.jpg)

ws21
![](pics/img9.21.jpg)

ws22 
![](pics/img9.22.jpg)

- Здесь я поняла, что пинги не проходят с использованием NAT Network. В настройках VirtualBox изменила на каждой машине первый адаптер на тип подключения NAT, второй и третий - на Iternal Network, с сетями r1-ws11, r1-r2, r2-ws21-ws22, переписала конфигурационные файлы под новые сетевые интерфейсы и все заработало.

- Пинг с ws11 на роутер r2:
![](pics/img9.23.jpg)

- На r2 пинг доходит (*tcpdump -tn -i enp0s8*):
![](pics/img9.24.jpg)

#### 5.4. Добавление статических маршрутов

- Добавить в роутеры r1 и r2 статические маршруты в файле конфигураций:
r1
![](pics/img9.25.jpg)

r2
![](pics/img9.26.jpg)

- Tаблицы с маршрутами на роутерах (*ip r*):

r1 
![](pics/img9.27.jpg)

r2
![](pics/img9.28.jpg)

- Kоманды *ip r list 10.10.0.0/18* и  *ip r list 0.0.0.0/0* на ws11:
![](pics/img9.29.jpg)

- Для адреса 10.10.0.0/18 был выбран маршрут, отличный от 0.0.0.0/0, так как маршрут по умолчанию имеет меньшую приоритетность - выбирается тот вариант, где маска длиннее.

#### 5.5. Построение списка маршрутизаторов

- Запусти на r1 команду дампа *tcpdump -tnv -i eth0*:
![](pics/img9.30.jpg)

- Построение списка маршрутизаторов на пути от рабочей станции 11 до 21 при помощи утилиты traceroute:
![](pics/img9.31.jpg)

- Каждый отправленный между машинами пакет проходит определенное количество узлов на пути к цели. Команда traceroute отправляет пакеты и смотрит адрес ответившего узла. Каждый раз отправляется по три пакета и для каждого из них измеряется время прохождения. Пакет отправляется на случайный порт. Когда утилита traceroute получает сообщение от целевого узла о том, что порт недоступен, трассировка считается завершенной.

#### 5.6. Использование протокола **ICMP** при маршрутизации

- Запуск на r1 перехвата сетевого трафика, проходящего через eth0 (enp0s8) с помощью команды *tcpdump -n -i eth0 icmp* :
![](pics/img9.32.jpg)

- Пинг с ws11 несуществующего IP (например, *10.30.0.111*) с помощью команды *ping -c 1 10.30.0.111* :
![](pics/img9.33.jpg)

- Сохранены дампы образов виртуальных машин.

## Part 6. Динамическая настройка IP с помощью **DHCP**

- Для работы со службой DHCP на r1 и r2 установлена утилита isc-dhcp-server (sudo apt-get install isc-dhcp-server).

- Для r2 настрена в файле */etc/dhcp/dhcpd.conf* конфигурацию службы *DHCP* - указан адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети:
![](pics/img10.1.jpg)

- В файле *resolv.conf* прописан *nameserver 8.8.8.8*:
![](pics/img10.2.jpg)

- Перезагрузка службы *DHCP* командой *systemctl restart isc-dhcp-server*:
![](pics/img10.3.jpg)

- Машина ws21 перезагружена при помощи *reboot* и через *ip a* видно, что она получила адрес:
![](pics/img10.4.jpg)

Предварительно изменен конфигурационный файл 00-installer-config:
![](pics/img10.5.jpg)

- На второй машине командой *ip a* узнаем новый адрес. Пинг ws22 с ws21:
![](pics/img10.6.jpg)

- Чтобы указать MAC адрес у ws11, в *etc/netplan/00-installer-config.yaml* надо добавить строки: *macaddress: 10:10:10:10:10:BA*, *dhcp4: true* и изменить настройки сети в интерфейсе Virtualbox:
![](pics/img10.7.jpg)

- Для r1 настройки аналогично r2, но выдача адресов с жесткой привязкой к MAC-адресу (ws11):
Конфигурация службы DHCP (dhcpd.conf):
![](pics/img10.8.jpg)

resolv.conf:
![](pics/img10.9.jpg)

Перезагрузка службы DHCP:
![](pics/img10.10.jpg)

- Проведение аналогичных тестов:
Перезагружаем ws11 и узнаем новый адрес
![](pics/img10.11.jpg)

Пинг соединения ws22 с ws11:
![](pics/img10.12.jpg)

- Запрос с ws21 обновления ip адреса командой *sudo dhclient -v*:
![](pics/img10.13.jpg)

- ip до и после обновления:
before 
![](pics/img10.14.jpg)

after
![](pics/img10.15.jpg)

- Далее выполняются команды удаления старого адреса (*sudo dhclient -r*).

- В этой части задания были использованы две опции DHCP-протокола:
    - option routers ip-address [, ip-address...] - адреса шлюзов для клиентской сети (маршрутизаторы перечислены в порядке предпочтительности)
    - option domain-name-servers ip-address [, ip-address...] - список DNS-серверов, доступных клиенту (сервера перечислены в порядке предпочтительности)

## Part 7. **NAT**

- На машины r1, r2 и ws22 установлена утилита apache2 (*sudo apt-get install apache2*). Чтобы сделать сервер общедоступным, в файле */etc/apache2/ports.conf* на ws22 и r1 изменим строку *Listen 80* на *Listen 0.0.0.0:80*:

![](pics/img11.1.jpg)

![](pics/img11.2.jpg)

- Запуск веб-сервера Apache командой *service apache2 start* на ws22 и r1:

![](pics/img11.3.jpg)

![](pics/img11.4.jpg)


- Фаервол на r2 со следующими правилами:
    1) Удаление правил в таблице filter - `iptables -F`;
    2) Удаление правил в таблице "NAT" - `iptables -F -t nat`;
    3) Отбрасывать все маршрутизируемые пакеты - `iptables --policy FORWARD DROP`.

![](pics/img11.5.jpg)

- Запуск файл также, как в Части 4:

![](pics/img11.6.jpg)

- Проверка соединения между ws22 и r1 командой *ping* (при запуске файла с этими правилами, ws22 НЕ ДОЛЖНА «пинговаться» с r1):

![](pics/img11.7.jpg)
![](pics/img11.8.jpg)

- В фаерволе pазрешить маршрутизацию всех пакетов протокола *ICMP*: !
![](pics/img11.9.jpg)

- Проверка соединения между ws22 и r1 командой `ping` (при запуске файла с этими правилами, ws22 ДОЛЖНА «пинговаться» с r1):

![](pics/img11.10.jpg)
![](pics/img11.11.jpg)

- Добавление в файл ещё двух правил:
    - Включение **SNAT**, а именно маскирование всех локальных ip из локальной сети, находящейся за r2 (по обозначениям из Части 5 - сеть 10.20.0.0);
    - Включение **DNAT** на 8080 порт машины r2 и добавитление к веб-серверу Apache, запущенному на ws22, доступа извне сети.

![](pics/img11.12.jpg)

- Запуск файла также, как в Части 4 (перед тестированием отключен сетевой интерфейс *NAT* в VirtualBox):

![](pics/img11.13.jpg)

- Проверка соединения по TCP для *SNAT*: для этого с ws22 подключяемся к серверу Apache на r1 командой *telnet [адрес] [порт]*:

![](pics/img11.14.jpg)

При пинге с ws22 на r1, командой tcpdump можно проверить соединение: 

![](pics/img11.15.jpg)

- Проверка соединения по TCP для *DNAT*: для этого с r1 подключяемся к серверу Apache на ws22 командой *telnet* (обращение по адресу r2 и порту 8080):

![](pics/img11.16.jpg)

## Part 8. Дополнительно. Знакомство с **SSH Tunnels**

- Запуск на r2 фаервола с правилами из Части 7:

![](pics/img12.1.jpg)

![](pics/img12.2.jpg)

- Запуск веб-сервера *Apache* на ws22 только на localhost. Для этого в файле */etc/apache2/ports.conf* изменена строка `Listen 80` на `Listen localhost:80`:

![](pics/img12.3.jpg)

![](pics/img12.4.jpg)

- Воспользуемся *Local TCP forwarding* с ws21 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws21:

![](pics/img12.5.jpg)

- Воспользуйся *Remote TCP forwarding* c ws11 до ws22, чтобы получить доступ к веб-серверу на ws22 с ws11:

![](pics/img12.6.jpg)

- Для проверки, сработало ли подключение в обоих предыдущих пунктах, переходим во второй терминал и выполняем команду *telnet 127.0.0.1 [локальный порт]*:
ws22

![](pics/img12.7.jpg)

ws11

![](pics/img12.8.jpg)

